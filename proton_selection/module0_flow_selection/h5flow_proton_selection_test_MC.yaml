################################################################################
##                                                                            ##
##    CONTAINS: Configurations to run proton selection. Based on              ##
##              https://github.com/DUNE/ndlar_flow/blob/main/yamls/           ##
##              module0_flow/workflows/analysis/stopping_muons.yaml.          ##
##                                                                            ##
################################################################################

flow:
  source: events
  stages: [proton_sel]
  #drop: ['charge', 'combined', 'geometry_info', 'lar_info', 'run_info']

resources:
  - !include ../../../ndlar_flow/yamls/module0_flow/resources/RunData.yaml
  - !include ../../../ndlar_flow/yamls/module0_flow/resources/LArData.yaml
  - !include ../../../ndlar_flow/yamls/module0_flow/resources/Geometry.yaml
  - !include ../../../ndlar_flow/yamls/module0_flow/resources/ParticleData.yaml
  - !include ../../../ndlar_flow/yamls/module0_flow/resources/DisabledChannels.yaml

events:
  classname: H5FlowDatasetLoopGenerator
  path: h5flow.modules
  dset_name: 'charge/events'
  params:
    chunk_size: 32

## Calibration modules (Time Dep Gain + Electron Lifetime)
#tdg_calib:
#  classname: TimeDependentGain
#  path: module0_flow.reco.charge.time_dependent_gain
#  requires:                                                                          
#    - 'charge/hits'
#  params:
#    hits_dset_name: 'charge/hits'
#    calib_dset_name: 'charge/q_calib_tdg'
#    gain_file: '../../../ndlar_flow/data/module0_flow/module0_time_dependent_gain.npz'
#
#el_calib:
#  classname: ElectronLifetimeCalib
#  path: module0_flow.reco.combined.electron_lifetime
#  requires:
#    - name: 'combined/hit_drift'
#      path: ['charge/hits', 'combined/hit_drift']
#    - 'charge/hits'
#    - name: 'charge/q_calib_tdg'
#      path: ['charge/hits', 'charge/q_calib_tdg']
#  params:
#    hits_dset_name: 'charge/hits'
#    charge_dset_name: 'charge/q_calib_tdg'
#    drift_dset_name: 'combined/hit_drift'
#    calib_dset_name: 'combined/q_calib_el'
#    mode: 'calibration'
#    electron_lifetime_file: '../../../ndlar_flow/data/module0_flow/ElecLifetimeFit_Module1.npz'

# Tracklet merger module
tracklet_merger:
  classname: TrackletMerger
  path: module0_flow.reco.combined.tracklet_merging
  requires:
   - 'combined/tracklets'
   - name: 'combined/track_hits'
     path: ['combined/tracklets', 'charge/hits']
   - name: 'combined/track_hit_charge'
     path: ['combined/tracklets', 'charge/hits']   
   - name: 'combined/track_hit_drift'
     path: ['combined/tracklets', 'charge/hits', 'combined/hit_drift']
  params:
    # inputs
    hits_dset_name: 'charge/hits'
    track_charge_dset_name: 'combined/track_hit_charge'
    track_hits_dset_name: 'combined/track_hits'
    track_hit_drift_dset_name: 'combined/track_hit_drift'
    tracks_dset_name: 'combined/tracklets'

    # output
    merged_dset_name: 'combined/tracklets/merged'

    # configuration parameters
    pdf_filename: '../../../ndlar_flow/data/module0_flow/joint_pdf-3_0_0.npz'
    # download link: https://portal.nersc.gov/project/dune/data/Module0/merged/reco_data/joint_pdf-3_0_0.npz
    pvalue_cut: 0.02
    max_neighbors: 5

# Proton selection module
proton_sel:
  classname: ProtonSelection # proton_selection.py
  path: proton_selection
  requires:
    - 'combined/tracklets'
    - 'combined/t0'
    - 'charge/hits'
    #- name: 'combined/q_calib_el'
    #  path: ['charge/hits', 'combined/q_calib_el']
    - name: 'combined/hit_drift'
      path: ['charge/hits', 'combined/hit_drift']
    - name: 'mc_truth/trajectories'
      path: ['charge/raw_events', 'mc_truth/events', 'mc_truth/trajectories']
    #- name: 'combined/track_hits'
    #  path: ['combined/tracklets', 'charge/hits']
    #- name: 'combined/track_hit_drift'
    #  path: ['combined/tracklets', 'charge/hits', 'combined/hit_drift']

  params:
    # inputs
    hits_dset_name: 'charge/hits'
    ext_trigs_dset_name: 'charge/ext_trigs'
    t0_dset_name: 'combined/t0'
    tracklet_dset_name: 'combined/tracklets'
    hit_drift_dset_name: 'combined/hit_drift'
    truth_trajectories_dset_name: 'mc_truth/trajectories'
    charge_dset_name: 'charge/hits'

    # configuration parameters
    fid_cut: 20 # mm
    cathode_fid_cut: 20 # mm
    profile_dx: 20 # mm
    larpix_gain:
      mc: 250 # e/mV
      medm: 221 # e/mV
      high: 221 # e/mV
    curvature_rr_correction:
      mc: 1.0
      medm: 1.0
      high: 1.0